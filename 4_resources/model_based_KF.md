# Model-based Method: Kalman Filter

## 1. Fault Information
An essential application for RflyMAD is to construct fault diagnosis methods. Here we take a simple fault type as an example to diagnose. Detailed information about this fault could be seen in the following table.

| Fault Type     | Start Time     | Duration       |Fault Parameter| Flight Status|
| -------------- | -------------- | -------------- | ------------- | ------------ |
| Motor(1)       | 106s           | 30s            | 0.6           | Hover        |
| Motor(4)       | 116s           | 5s             | 0.8           | Hover        |
| Motor(3)       | 126s           | 60s            | 0.5           | Hover        |

Note: motor(i) means the $i^{th}$ motor of multicopter has a fault.

From the table, we could know that the multicopter is hovering while the faults are injected. Start time means when the fault is injected during the whole flight process. The data used in this sample is an HIL simulation data, and mainly message topics are in ULog data that can be accessed from [here](https://bhpan.buaa.edu.cn/link/AAC765607ACC0C4104BE0ADA90F56D850B).

## 2. Simplified Dynamic Model Construction
In this sample, the fault parameter could also be called the loss factor, for it represents the failure degree of a motor. Define the loss factor as $\eta_{i}\in[0,1],i=1,2,3,4$, which represents the total number of propulsors as four. If a propulsor's loss factor is $\eta_{i}$, the thrust of the $i^{th}$ propulsor on the multicopter is only equal to $(1-\eta_{i})\times100\%$ of thrust in the normal working state. Define the thrust of the $i^{th}$ propulsor as $f_{i}$, we could write loss factor and thrust in the forms of vector and matrix as
$$
\begin{aligned}
    {\mathbf f}&=[f_{1}\ f_{2}\ f_{3}\ f_{4}]^{T}, {\mathbf \Gamma}_{f}=diag(f_{1}, f_{2}, f_{3},f_{4}), \\
    \mathbf{\eta}&=[\eta_{1}\ \eta_{2}\ \eta_{3}\ \eta_{4}]^{T}, {\mathbf \Gamma}_{\eta}=diag(\eta_{1}, \eta_{2}, \eta_{3}, \eta_{4}).
\end{aligned}
$$

In order to detect the fault by using the RflyMAD dataset, we need to find the relationship between the loss factor and the states of quadrotors. Considering the multicopter is hovering when the faults occur, we could neglect aerodynamic damping and make a small angle assumption to build a simplified function to describe the movement of the quadrotor as [^1] [^2]

$$
\begin{aligned}
\ddot{z} & = \frac{T}{m} - g \\
J_x\ddot{\phi} & = \tau_x \\
J_y\ddot{\theta} & = \tau_y \\
J_z\ddot{\psi} & = \tau_z
\end{aligned}
$$

where $(x, y, z)$ and $(\phi, \theta, \psi)$ are the position and attitude of the quadrotor, $(J_x, J_y, J_z)$ are the moment of inertia. $T$ is the total force and $ (\tau_x, \tau_y, \tau_z)$ is torque generated by propellors. $m$ is the mass of the quadrotor. So the linear approximate state equation of the quadrotor aircraft system at low speed and small angle is

$$
\dot{\mathbf{x}} = \mathbf{Ax} + \mathbf{B}\underbrace{(\mathbf{u}_f - \mathbf{g})}_{\mathbf{u}} = \mathbf{Ax} + \mathbf{B}(\mathbf{B}_f\mathbf{f} - \mathbf{g})
$$

where $\mathbf{B}_f \in \mathbb{R}^{4\times4}$ is the control efficiency matrix [^3], specific expressions of the state vector and other parameters are

$$
\begin{aligned}
    \mathbf{x} &= [z\quad\phi\quad\theta\quad\psi\quad\dot{z}\quad \dot{\phi}\quad \dot{\theta}\quad \dot{\psi}]^{T} \in \mathbb{R}^{8},\\
    \mathbf{u}_{f} &= [T\quad\tau_{x}\quad\tau_{y}\quad\tau_{z}]^{T} \in \mathbb{R}^{4},\\
    \mathbf{g}&= [mg\quad0\quad0\quad0]^{T} \in \mathbb{R}^{4},\\
    \mathbf{A}&=\left[  \begin{matrix}
        \mathbf{0}_{4\times4} & \mathbf{I}_{4}  \\
        \mathbf{0}_{4\times4} & \mathbf{0}_{4\times4} 
    \end{matrix}\right] \in \mathbb{R}^{8\times8},\\
    \mathbf{B}&= \left[  \begin{matrix}
        \mathbf{0}_{4\times4}  \\
        \mathbf{J}_{f}^{-1}  
    \end{matrix}\right] \in \mathbb{R}^{8\times4},\\
    \mathbf{J}_{f}&= diag(-m,J_{x},J_{y},J_{z}) \in \mathbb{R}^{4\times4}.\\
\end{aligned}
$$

Taking the loss factor into consideration, we could change the control input like

$$
\begin{aligned}
    \mathbf{u} &= \mathbf{B}_{f}(\mathbf{I}-\mathbf{\Gamma} _{\eta})\mathbf{f}-\mathbf{g}\\
        &= \mathbf{B}_{f}\mathbf{f}-\mathbf{g}-\mathbf{B}_{f}\mathbf{\Gamma} _{\eta}\mathbf{f} \\
        &= \mathbf{u}_{0}-\mathbf{B}_{f}\mathbf{\Gamma}_{f}\mathbf{\eta}
\end{aligned}
$$

Thus, expand the loss factor $\mathbf{\eta}$ into the state vector to form a new state vector $\tilde{\mathbf{x}}$ and discretize the state function. We could get the final function used for state estimation as

$$
\begin{aligned}
    \dot{\tilde{\mathbf{x}}}_{k+1} &= \left[ \begin{matrix}
    \mathbf{I}_{4}&\mathbf{I}_{4}\Delta t & -\frac{\Delta t^{2}}{2}\mathbf{M} \\
    \mathbf{0}_{4\times4} & \mathbf{I}_{4} & -\Delta t\mathbf{M} \\
    \mathbf{0}_{4\times4}& \mathbf{0}_{4\times4}& \mathbf{I}_{4}
\end{matrix} \right] \tilde{\mathbf{x}}_{k} + \left[ \begin{matrix}
    \frac{\Delta t^{2}}{2}\mathbf{J}_{f}^{-1} \\ \Delta t\mathbf{J}_{f}^{-1} \\ \mathbf{0}_{4\times4}
\end{matrix} \right] \mathbf{u}_{0},  \\
\mathbf{y} &= \left[\mathbf{I}_{8\times8}\quad\mathbf{0}_{8\times4} \right]\tilde{\mathbf{x}}_{k}, \quad \mathbf{M}=\mathbf{J}_{f}^{-1}\mathbf{B}_{f}\mathbf{\Gamma}_{f}
\end{aligned}
$$

Above final function is able to estimate the size of the loss factor by Kalman Filter (KF). $\Delta t$ in the above final function is the sampling time in discretization. From the above function and state vector $\tilde{\mathbf{x}}$, it is easy to find that the information about position $(x, y, z)$, attitude angle $(\phi, \theta, \psi)$, attitude angle rate $(\dot{\phi}, \dot{\theta}, \dot{\psi})$ and motor throttle $\sigma$ of multicopter is in need. In our RflyMAD dataset, it could be get from the `ULog` data by using the [toolkit](https://github.com/lerlis/Data_processing_tools) we developed and introduced in [Dataset](./dataset.html). The detailed information about the data in shown in the following table.

| Symbol         |Source File in ULog| Usage          |
| :------------: | ----------------- | -------------- |
| $\sigma$       | actuator\_outputs\_0.csv | Input parameter of ESC |
| $(x, y, z)$    | vehicle\_local\_position\_0.csv | Observation vector of KF |
| $(\phi, \theta, \psi)$ | vehicle\_attitude\_0.csv | Observation vector of KF |
| $(\dot{\phi}, \dot{\theta}, \dot{\psi})$ | sensor\_combined\_0.csv | Observation vector of KF |

Note: Other information like physical parameters of the multicopter is shown in [OpenHA-Models](https://rfly-openha.github.io/documents/4_resources/multicopter.html) or documents in our RflyMAD dataset.

## 3. Experimental results

With the Kalman Filter and detailed information from RflyMAD dataset, the estimated results are shown in the following figure. Compared with the actual fault information, we could find that the estimation result is accurate.
<img src="./diagnosis2.png" style="zoom: 50%;" />

The above steps show how to use RflyMAD dataset in the process of fault diagnosis, and users can apply their own methods with more message topics in our RflyMAD dataset to get a better results! 

## Reference
[^1]:Xu, R., & Ozguner, U. (2006, December). Sliding mode control of a quadrotor helicopter. In Proceedings of the 45th IEEE Conference on Decision and Control (pp. 4957-4962). IEEE.
[^2]:Amoozgar, M. H., Chamseddine, A., & Zhang, Y. (2013). Experimental test of a two-stage Kalman filter for actuator fault detection and diagnosis of an unmanned quadrotor helicopter. Journal of Intelligent & Robotic Systems, 70, 107-117.
[^3]:Du, G. X., & Sun, L. (2018, July). Loss of effectiveness information observability analysis for multicopters. In 2018 3rd International Conference on Advanced Robotics and Mechatronics (ICARM) (pp. 572-576). IEEE.
